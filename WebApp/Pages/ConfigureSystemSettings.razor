@page "/AdminSettings"
@using ClassLibraryModel
@using ClassLibraryDal
@inject ClassLibraryModel.SettingsService SettingsService
@inject StudentService StudentService

<div class="container-fluid">
    <div class="row">
        <div id="sidebar" class="@SidebarClass col-md-3 p-0">
            <div class="sidebar-header d-flex align-items-center justify-content-start p-3 bg-dark text-white">
                <img src="Images/SMS-Logo.png" alt="Logo" class="me-2" style="height: 40px;" />
                <span>Student Attendance System</span>
            </div>
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" role="menu">
                    <li class="nav-item">
                        <a href="/dashboard" class="nav-link">
                            <i class="nav-icon fas fa-th"></i>
                            <p> welcome to Dashboard</p>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link d-flex  gap-10" style="width:230px ; margin-left:13px" @onclick="@(() => ToggleMenu("inventory-menu"))">
                            <i class="nav-icon fas  mt-1  fa-tachometer-alt"></i>
                            <p >
                                Inventory
                                <i class=" d-flex justify-end fas @(IsMenuExpanded("inventory-menu") ? "fa-angle-down" : "fa-angle-left")"></i>
                            </p>
                        </a>
                        <ul id="inventory-menu" style="width:230px ; margin-left:13px" class="nav nav-treeview @(IsMenuExpanded("inventory-menu") ? "open" : "")">
                            <li class="nav-item">
                                <a href="/medicinerecord" style="width:230px ; margin-left:13px" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>List of Medicines</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/add_medicine_record" style="width:230px ; margin-left:13px" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Medicine Record</p>
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-item" style="width:230px ; margin-left:13px">
                        <a class="nav-link" @onclick="@(() => ToggleMenu("sales-menu"))">
                            <i class="nav-icon fas fa-copy"></i>
                            <p>
                                Sales Record
                                <i class="fas @(IsMenuExpanded("sales-menu") ? "fa-angle-down" : "fa-angle-left") right"></i>
                            </p>
                        </a>
                        <ul id="sales-menu" class="nav nav-treeview @(IsMenuExpanded("sales-menu") ? "open" : "")">
                            <li class="nav-item">
                                <a href="/salesrecord" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Sales Report</p>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="/payments" class="nav-link">
                                    <i class="far fa-circle nav-icon"></i>
                                    <p>Payments Report</p>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>

        <div id="main-content" style="margin-left: @SidebarMargin">
            <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm fixed-top" style="padding-left: @NavbarPadding">
                <div class="container-fluid">
                    <i class="fas @(SidebarClass == "sidebar-expanded" ? "fa-bars" : "fa-times") me-3 sidebar-toggle-icon" @onclick="ToggleSidebar"></i>

                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a href="#" class="nav-link">Home</a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">Contact</a>
                        </li>
                    </ul>

                    <div class="ms-auto">
                        <LoginDisplay />
                    </div>
                </div>
            </nav>

            <div class="row mt-5 pt-5">
                <div class="col-md-3">
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action" @onclick="ShowSystemSettings">
                            <i class="fas fa-cogs me-2"></i> System Settings
                        </button>
                        <button class="list-group-item list-group-item-action" @onclick="ShowStudentManagement">
                            <i class="fas fa-users me-2"></i> Student Management
                        </button>
                        <button class="list-group-item list-group-item-action" @onclick="ShowAttendanceSettings">
                            <i class="fas fa-calendar-check me-2"></i> Attendance Settings
                        </button>
                        <button class="list-group-item list-group-item-action" @onclick="ShowReportGeneration">
                            <i class="fas fa-file-alt me-2"></i> Report Generation
                        </button>
                        <button class="list-group-item list-group-item-action" @onclick="ShowMaintenanceSettings">
                            <i class="fas fa-tools me-2"></i> System Maintenance
                        </button>
                    </div>
                </div>

                <div class="col-md-9">
                    @if (currentView == "SystemSettings")
                    {
                        <SystemSettingsForm Settings="Settings" OnSave="SaveSettings" />
                    }
                    else if (currentView == "StudentManagement")
                    {
                        <StudentManagementPanel />
                    }
                    else if (currentView == "AttendanceSettings")
                    {
                        <AttendanceSettingsForm Settings="Settings" />
                    }
                    else if (currentView == "ReportGeneration")
                    {
                        <ReportGenerationPanel />
                    }
                    else if (currentView == "Maintenance")
                    {
                        <SystemMaintenancePanel Settings="Settings" />
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string currentView = "SystemSettings";
    private SystemSettings Settings { get; set; } = new();
    private string SidebarClass { get; set; } = "sidebar-expanded";
    private string SidebarMargin { get; set; } = "250px";
    private string NavbarPadding { get; set; } = "250px";
    private Dictionary<string, bool> menuStates = new();

    protected override void OnInitialized()
    {
        Settings = SettingsService?.GetSettings() ?? new SystemSettings();
    }

    private void ShowSystemSettings() => currentView = "SystemSettings";
    private void ShowStudentManagement() => currentView = "StudentManagement";
    private void ShowAttendanceSettings() => currentView = "AttendanceSettings";
    private void ShowReportGeneration() => currentView = "ReportGeneration";
    private void ShowMaintenanceSettings() => currentView = "Maintenance";

    private void SaveSettings()
    {
        if (Settings != null)
        {
            SettingsService.SaveSettings(Settings);
        }
    }

    private void ToggleSidebar()
    {
        SidebarClass = SidebarClass == "sidebar-expanded" ? "sidebar-hidden" : "sidebar-expanded";
        SidebarMargin = SidebarClass == "sidebar-expanded" ? "250px" : "0";
        NavbarPadding = SidebarMargin;
    }

    private void ToggleMenu(string menuId)
    {
        if (menuStates.ContainsKey(menuId))
        {
            menuStates[menuId] = !menuStates[menuId];
        }
        else
        {
            menuStates[menuId] = true;
        }
    }

    private bool IsMenuExpanded(string menuId) => menuStates.ContainsKey(menuId) && menuStates[menuId];
}